<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - {{ current_chat.title }}</title>
    <style>
        body,html{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;display:flex;height:100vh;background-color:#f0f2f5}
        #sidebar{width:250px;background:#2c3e50;color:white;display:flex;flex-direction:column;padding:10px;border-right:1px solid #ddd}
        #sidebar h2{margin:10px 0 20px 10px}#sidebar a.new-chat-btn{display:block;padding:10px 15px;background:#3498db;color:white;text-align:center;border-radius:5px;text-decoration:none;margin-bottom:15px}
        #chat-list{list-style:none;padding:0;margin:0;overflow-y:auto}#chat-list li a{display:block;color:#ecf0f1;text-decoration:none;padding:12px 15px;border-radius:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        #chat-list li a.active,#chat-list li a:hover{background-color:#34495e}#sidebar .sidebar-footer{margin-top:auto;padding:10px}
        #sidebar .sidebar-footer a{color:#ccc;text-decoration:none;display:block;text-align:center;padding:10px}
        #main-content{flex-grow:1;display:flex;flex-direction:column;background:white}#conversation{flex-grow:1;padding:20px;overflow-y:auto}
        .message{margin-bottom:20px;max-width:80%;padding:15px;border-radius:18px;line-height:1.5;display:flex;flex-direction:column}
        .message.user{background:#3498db;color:white;margin-left:auto;border-bottom-right-radius:5px}.message.assistant{background:#ecf0f1;color:#2c3e50;margin-right:auto;border-bottom-left-radius:5px;white-space:pre-wrap}
        .message .role{font-weight:700;margin-bottom:5px;font-size:.8em;text-transform:uppercase}.message .content{word-wrap:break-word}
        #input-area{padding:20px;border-top:1px solid #ddd;background-color:#f9f9f9}#input-area form{display:flex;gap:10px}
        #input-area textarea{flex-grow:1;padding:10px;border-radius:5px;border:1px solid #ccc;resize:none;font-size:1em}
        #input-area button{padding:0 20px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer}
        #file-upload-area{margin-top:10px;font-size:.9em}.flash{padding:15px;margin:0 20px 15px;border-radius:5px;color:white}
        .flash.success{background-color:#2ecc71}.flash.error{background-color:#e74c3c}
        /* Updated Styles for the Chat Toolbar */
        #chat-toolbar { padding: 10px 20px; border-bottom: 1px solid #ddd; background-color: #f8f8f8; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; }
        #chat-toolbar h3 { margin: 0; flex-grow: 1; }
        #chat-toolbar form { display: inline-flex; gap: 5px; align-items: center; }
        #chat-toolbar input, #chat-toolbar select { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
        #chat-toolbar button { font-size: 0.9em; padding: 5px 10px; cursor: pointer; border: 1px solid #ccc; border-radius: 3px; background-color: #fff; }
        #chat-toolbar button.delete-btn { border-color: #e74c3c; color: #e74c3c; }
        .model-switcher { margin-left: auto; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <h2>{{ session.username }}'s Chats</h2>
        <a href="{{ url_for('new_chat') }}" class="new-chat-btn">+ New Chat</a>
        <ul id="chat-list">
            {% for id, title in chats.items() %}
            <li><a href="{{ url_for('view_chat', chat_id=id) }}" class="{{ 'active' if id == current_chat.id else '' }}">{{ title }}</a></li>
            {% endfor %}
        </ul>
        <div class="sidebar-footer"><a href="{{ url_for('logout') }}">Logout</a></div>
    </aside>

    <main id="main-content">
        <!-- Toolbar with model switcher -->
        <div id="chat-toolbar">
            <h3>{{ current_chat.title }}</h3>
            <!-- Model Switcher Form -->
            <form action="{{ url_for('select_model') }}" method="post" class="model-switcher">
                <label for="model-select">Model:</label>
                <select name="model" id="model-select" onchange="this.form.submit()">
                    {% for model in available_models %}
                        <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>{{ model }}</option>
                    {% endfor %}
                </select>
                <!-- Hidden input to know which chat to return to -->
                <input type="hidden" name="chat_id" value="{{ current_chat.id }}">
            </form>
            <hr style="width: 100%; border: none; border-top: 1px solid #eee; margin: 5px 0;">
            <!-- Rename Form -->
            <form action="{{ url_for('rename_chat', chat_id=current_chat.id) }}" method="post">
                <input type="text" name="new_title" placeholder="New chat name..." required>
                <button type="submit">Rename</button>
            </form>
            <!-- Duplicate Form -->
            <form action="{{ url_for('duplicate_chat', chat_id=current_chat.id) }}" method="post">
                <button type="submit">Duplicate</button>
            </form>
            <!-- Delete Form -->
            <form action="{{ url_for('delete_chat', chat_id=current_chat.id) }}" method="post">
                <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this chat permanently?');">Delete</button>
            </form>
        </div>

        <div id="conversation">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% for msg in current_chat.messages %}
            <div class="message {{ msg.role }}">
                <div class="role">{{ 'You' if msg.role == 'user' else 'Assistant (' + (current_chat.model or selected_model) + ')' }}</div>
                <div class="content">{{ msg.content }}</div>
            </div>
            {% endfor %}
        </div>

        <div id="input-area">
            <form method="post" action="{{ url_for('view_chat', chat_id=current_chat.id) }}">
                <div style="flex-grow:1">
                    <textarea name="prompt" rows="3" cols="120" placeholder="Chat with {{ selected_model }}..."></textarea>
                    <div id="file-upload-area">
                        <label for="context_file">Attach File (optional):</label>
                        <input type="file" name="context_file" id="context_file">
                    </div>
                </div>
                <button type="submit">Send</button>
            </form>
        </div>
    </main>
</body>
</html>